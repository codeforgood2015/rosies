<!DOCTYPE html>

<html>
<head>
<script src= "http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js">
</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<link href='http://fonts.googleapis.com/css?family=Open+Sans|Roboto|Playfair+Display' rel='stylesheet' type='text/css'>
</head>

<body ng-app = "dateTime">
<div ng-controller="datetimeController as ctrl">

<button id = "back"  ng-show="currentSelect >= 0" ng-click = "ctrl.back()"><span style = "font-family: 'Times New Roman';">&#9166</span><br>BACK </button>
<div id = "header"><br>
<img id = "logo" src = '../public/images/logo.png'>
<h1>Food Pantry Sign Up</h1>
</div>

<div ng-show = "currentSelect === -1">
	<h3>Log In</h3>
	<form name = 'guestForm' novalidate>
	<span class = "label"> First Name: </span><input name = "first" type = "text" ng-model = "user.firstName" placeholder = "type here" required = ""><br>
	<span class = "error" ng-show = "ctrl.attempted && !user.firstName">please enter your first name</span><br>

	<span class = "label"> Last Name: </span><input name = "last" type = "text" ng-model = "user.lastName" placeholder = "type here" required = ""><br>
	<span class = "error" ng-show = "ctrl.attempted && !user.lastName">please enter your last name</span><br>

	<span class = "label"> Date of Birth: </span>

	<select name = "year" id = "dobyear" ng-model = "user.dob.year" ng-change = "ctrl.updateDates()" ng-options = "year for year in ctrl.years" required = ""></select>
	<select name = "month" id = "dobmonth" ng-model = "user.dob.month" ng-change = "ctrl.updateDates()" ng-options = "month for month in ['January', 'February', 'March', 'April', 'May','June', 'July', 'August', 'September', 'October', 'November', 'December']" required = ""></select>
	<select name = "day"id = "dobdate" ng-model = "user.dob.day"required = ""><option ng-repeat = "day in ctrl.monthDayPairs[0]" value = {{day}}>{{day}}</options></select><br>
	<span class = "error" ng-show = "ctrl.attempted && (!user.dob.day || !user.dob.month || !user.dob.year)">please fill out your date of birth</span>
<br><br>
	<button type = "submit" class = "button-1" ng-click = "ctrl.lookup(user)">next</button>
	</form>

</div>

<div ng-show = "currentSelect === 0">
<h3>Select a Date</h3>
	<br>
	<button class = "button0" ng-click="ctrl.selectDate(0); ctrl.next()"><b>{{ctrl.dateSlots[0]}}</b><br>(today)</button>
	<button class = "button0" ng-click="ctrl.selectDate(1);ctrl.next()"><b>{{ctrl.dateSlots[1]}}</b><br>(tomorrow)</button>
</div>

<div ng-show = "currentSelect === 1">
<h3>Select a Time</h3>
<div ng-repeat="time in ctrl.timeSlots"><button class = "button1" ng-click="ctrl.selectTime(time); ctrl.next()">{{time}}</button></div>
</div>

<div ng-show = "currentSelect === 2">
<h3>Premade Bag</h3>
	<button class = "button2" ng-click="ctrl.selectBag('yes'); ctrl.next()"><b>YES</b><br>make me a bag</button>
	<button class = "button2" ng-click="ctrl.selectBag('no'); ctrl.next()"><b>NO</b><br>I want to pick my own food</button>
</div>

<!-- <div ng-show = "currentSelect === 3">
<h3>Dietary Constraints</h3>
	<button class = "button3" ng-click="ctrl.allergies = true;"><b>YES</b> </button>
	<button class = "button3" ng-click="ctrl.clearAllergies(); allergies = ''; ctrl.next()"><b>NO</b></button>
	<br><br>
	<textarea id = "allergybox" rows = "4" cols = "50" ng-show = "ctrl.allergies" ng-model="allergies" placeholder = "type your dietary constraints here"></textarea>
	<br>
	<button class = "button3-1" ng-click = "ctrl.next()" ng-show = "ctrl.allergies">done</button>
</div> -->

<div ng-show = "currentSelect ===3">
	<h3>Confirmation</h3>
	<table>
		<tr>
			<td>Name: </td>
			<td>{{user.firstName}} {{user.lastName}}</td>
		</tr>
		<tr>
			<td>Date: </td>
			<td>{{ctrl.dateSelect}}</td>
		</tr>
		<tr>
			<td>Time: </td>
			<td>{{ctrl.timeSelect}}</td>
		</tr>
		<tr>
			<td>Pre-made Bag: </td>
			<td>{{ctrl.bag}}</td>
		</tr>
<!-- 		<tr>
			<td>Dietary constraints: </td>
			<td>{{allergies}}</td>
		</tr> -->
	<table>
	<button class = "button4" ng-show = '!submitSuccess' ng-click = "ctrl.sendReservation(user, ctrl.dateSelect, ctrl.timeSelect, ctrl.bag)">submit</button><br>
	<span ng-show = "submitSuccess">Successfully Saved!<br><button class = 'button5' ng-click = 'ctrl.reset()'>exit</button></span>
</div>
</div>



</body>
</html>

<script>
	var range = function(start, end, up){
		result = [];
		if (up === 1){
			for(var i = start; i <= end; i++){
			result.push(i);
		}
		}
		else{
			for(var i = end; i >= start; i--){
			result.push(i)
			}
		};
		return result
	}

	var app = angular.module('dateTime', []);
	app.controller('LoginController', function($scope, $http){
		

	});
/*			$.ajax('/auth/guest', {
				data: {
					firstName: user.firstName,
					lastName: user.lastName, 
					dob: user.dob
				},
				type: 'POST'
			}).done(function(data, textStatus, jqXHR) {
				console.log(data);
				if (data.success && data.content) {
					console.log($scope.currentSelect);
					$scope.currentSelect += 1;
					console.log($scope.currentSelect);
				} else {
					// TODO: Generate view for booked appointment
				}
			});*/
			
	app.controller('datetimeController', function($scope, $http){
		$scope.currentSelect = -1;
		this.attempted = false;
		$scope.submitSuccess = false;
		this.reset = function(){
			$scope.currentSelect = -1;
			$scope.user = {};
			this.dateSelect = '';
			this.timeSelect = '';
			this.bag = '';
			this.attempted = false;
		}
		this.next = function(){
			$scope.currentSelect += 1;
		};
		this.back = function(){
			$scope.currentSelect -= 1;
			if($scope.currentSelect == -1){
				this.reset();
			}
		};

		this.lookup = function(user){
			console.log(user);
			if(user && user.firstName && user.lastName && user.dob && user.dob.year && user.dob.month && user.dob.day){
				$http.post('/auth/guest', {
					firstName: user.firstName,
					lastName: user.lastName,
					dob: user.dob
				}).success(function(data, status, headers, config){
					console.log(data)
					console.log($scope.currentSelect);
					$scope.currentSelect +=1;
					console.log($scope.currentSelect);
				}).error(function(data, status, headers, config){
					console.log(status)
				});
			} else {
				this.attempted = true;
				console.log("uhoh")
			}
		}
		this.today = new Date(Date.now());
		this.tomorrow = new Date(Date.now() + 1000*60*60*24)
		this.dateSlots = [this.today.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'}), this.tomorrow.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'})];
		this.selectDate = function(dateChoice){
			this.dateSelect = this.dateSlots[dateChoice];
		};

		this.years = range(1900, this.today.getFullYear(), 0);
		this.monthDayPairs = {
			0 : range(1, 31, 1),
			1 : range(1, 28, 1),
			2 : range(1, 31, 1),
			3 : range(1, 30, 1), 
			4 : range(1, 31, 1),
			5 : range(1, 30, 1),
			6 : range(1, 31, 1),
			7 : range(1, 31, 1),
			8 : range(1, 30, 1),
			9 : range(1, 31, 1),
			10 : range(1, 30, 1),
			11 : range(1, 31, 1)		
		}

		this.updateDates = function(){
			myYear = $("#dobyear").val();
			myMonth = $("#dobmonth").val();
			myCurrentDate = $("#dobdate").val();
			myDates = range(1, 31, 1);
			console.log(myYear == '?');
			console.log(myMonth == '?');
			if(myYear != '?' && myMonth != '?'){
				console.log("this");
				myDates = this.monthDayPairs[myMonth];
				if(myYear % 4 === 0 && myMonth == 2){
					myDates = range(1, 29, 1);
				}
			}
			$("#dobdate").empty();
			$("#dobdate").append("<option></option>");
			console.log(myDates);
			for(var i = 1; i <= myDates.length; i++){
				console.log(i);
				$("#dobdate").append("<option value = " + String(i) + ">" + String(i) + "</option>");
			}
			if(myDates.indexOf(Number(myCurrentDate)) >= 0){
				$("#dobdate").val(myCurrentDate);
			}

		}
		this.timeSlots = ['9:00 am to 10:00 am', '10:00 am  to 11:00 am', '11:00 am to 12:00 noon', '4:30 pm to 5:30 pm', '5:30 pm to 6:30 pm'];
		this.selectTime = function(timeChoice){this.timeSelect = timeChoice;};

		this.selectBag = function(bagChoice){this.bag = bagChoice;};

		this.allergies = false;
		this.clearAllergies = function(){$('#allergybox').val(''); this.allergies = false;};

		this.sendReservation = function(user, rdate, rtime, rbag){
			if(user.firstName && user.lastName && user.dob && user.dob.year && user.dob.month && user.dob.day && rdate && rtime && rbag){

				fixedSlots = [['9:00', '10:00'], ['10:00', '11:00'], ['11:00', '12:00'], ['16:30', '17:30'], ['17:30', '18:30']];
				rtimeFixed = fixedSlots[this.timeSlots.indexOf(rtime)];
				fixedDates = [this.today, this.tomorrow];
				rdateFixed = fixedDates[this.dateSlots.indexOf(rdate)];
				if(rbag == 'yes'){
					rbagFixed = true;
				}
				else{
					rbagFixed = false;
				}
				console.log(rtimeFixed, rdateFixed)
				$http.post('/appointments/', {
					firstName: user.firstName,
					lastName: user.lastName,
					birthday: user.dob,
					date: rdateFixed,
					timeslot: rtimeFixed,
					premade: rbagFixed
				}).success(function(data, status, headers, config){
					$scope.submitSuccess = true;
				})
			}
			else{
				console.log("uhoh")
			}
		}
	});
</script>

<style>
input.ng-invalid{
	background-color: lightpink;
}
html{
	background-color: #734866;
	color:white;
	text-align:center;
	font-family: 'Roboto';
	font-size: 25px;
	background-image: url('../public/images/background.png');
	background-size: 100%;
}
.error{
	color:red;
	font-size:18px;

}
#logo{
	width: 150px;
}
button:focus{
	outline:0;
}
button{
	color: #3c84d5;
	font-size: 40px;
	border-radius: 10px;
	font-family: 'Roboto';
	background-color: white;
	border-top: 3px solid lightgray;
	border-left: 3px solid lightgray;
	border-right: 3px solid gray;
	border-bottom: 3px solid gray;
}

button:active{
	border-top: 3px solid gray;
	border-left: 3px solid gray;
	border-right: 3px solid lightgray;
	border-bottom: 3px solid lightgray;	
}

button.ng-disabled{
	background-color: black;
}
.button0{
	width: 33%;
	height: 250px;
	margin: 50px;
	margin-top: 0px;
}

.button1{
	width: 500px;
	height: 75px;
	margin: 20px;
	margin-top: 0px;
}

.button2{
	width: 600px;
	height: 250px;
	margin: 50px;
	margin-top: 0px;
}

.button3{
	width: 500px;
	height: 75px;
	margin: 20px;
	margin-top: 0px;
}

.button4{
	margin: 20px;
}

h1{
	margin: 0px;
	color: #d973aa;
	font-family: 'Playfair Display';
	font-size: 18px;
}
h3{
	width: 100%;
	font-size: 75px;
	margin-bottom: 20px;
	font-family: 'Playfair Display';
}

textarea{
	font-size: 35px;
}

table{
	margin-left: auto;
	margin-right: auto;
}

table tr td:nth-child(even){
	text-align: left;
	max-width: 300px;
}

table tr td:nth-child(odd){
	text-align: right;
	vertical-align: top; 
	padding-right: 20px;
}

#back{
	background-color: #3c84d5;
	color: white;
	width: 250px;
	height: 125px;
	position: fixed;
	left: 10px;
	top: 10px;
}
@media only screen and (max-width: 1300px){
	html{
		background-size: 200%;
		font-size: 30px;
	}

	h3{
		font-size: 60px;
	}
	.label{
		display: block;
		margin-right: auto;
		margin-right: auto;
		margin-top: 50px;
		font-size: 30px;
	}

	input{
		font-size: 30px;
	}

	select{
		font-size: 30px;
	}
	#back{
		width: 100px;
		height: 75px;
	}

	button{
		font-size: 25px;
		width: 25%;
	}
	.button0{
		width: 75%;
		height: 150px;
	}

	.button1{
		width: 80%;
		height: 50px;
	}

	.button2{
		width: 75%;
		height: 150px;
	}

	.button3{
		width: 500px;
		height: 75px;
		margin: 20px;
		margin-top: 0px;
	}

	.button4{
		margin: 20px;
	}

}
</style>